<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DRACULA CHAT // LOGIN FIXED</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dracula Palette */
      --bg-dark: #282a36;
      --bg-panel: #44475a;
      --bg-sidebar: #21222c;
      --fg: #f8f8f2;
      --comment: #6272a4;
      --purple: #bd93f9;
      --green: #50fa7b;
      --red: #ff5555;
      --yellow: #f1fa8c;
      --cyan: #8be9fd;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0; padding: 0;
      background-color: var(--bg-dark);
      color: var(--fg);
      font-family: 'Inter', sans-serif;
      height: 100vh; width: 100vw;
      overflow: hidden;
      display: flex;
    }

    /* === LAYOUT PRINCIPAL === */
    #app-layout {
      width: 100%; height: 100%;
      display: grid;
      grid-template-columns: 260px 1fr;
      background: var(--bg-dark);
    }
    
    /* === SIDEBAR === */
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid rgba(255,255,255,0.1);
      display: flex; flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
      z-index: 20;
    }

    .section-title {
        font-size: 0.7rem; color: var(--comment); 
        text-transform: uppercase; font-weight: bold;
        margin: 1.5rem 0 0.5rem 0;
        letter-spacing: 1px;
    }
    .section-title:first-child { margin-top: 0; }

    .nav-item {
        display: flex; align-items: center; gap: 10px;
        padding: 10px; border-radius: 8px;
        cursor: pointer; color: #ccc; transition: 0.2s;
        margin-bottom: 4px;
    }
    .nav-item:hover { background: var(--bg-panel); color: #fff; }
    .nav-item.active { background: var(--bg-panel); color: var(--purple); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    
    .nav-avatar { width: 26px; height: 26px; border-radius: 50%; object-fit: cover; border: 1px solid var(--comment); }
    .status-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 5px var(--green); }
    .unread-badge { margin-left: auto; background: var(--red); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; display: none; }

    /* === CHAT CONTAINER === */
    .chat-container {
      display: flex; flex-direction: column;
      height: 100%;
      position: relative;
      background: var(--bg-dark);
      min-width: 0; /* Previene overflow en flex children */
    }

    header {
      height: 60px; flex-shrink: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; align-items: center; padding: 0 20px;
      background: rgba(40, 42, 54, 0.95);
    }
    #mobile-menu { display: none; background: none; border: none; color: white; font-size: 1.5rem; margin-right: 15px; cursor: pointer; }

    /* Wrapper de mensajes */
    #messages-wrapper {
      flex-grow: 1; 
      overflow-y: auto; 
      min-height: 0; 
      padding: 20px;
      display: flex; flex-direction: column;
      scroll-behavior: smooth;
    }

    #messages-list {
      display: flex; flex-direction: column; gap: 16px;
      margin: 0; padding: 0; list-style: none;
      margin-top: auto; 
    }

    /* Estilos Mensajes */
    .msg-row { display: flex; gap: 12px; animation: fadeIn 0.2s ease-out; max-width: 100%; }
    .msg-row.me { flex-direction: row-reverse; }
    
    .msg-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--bg-panel); }
    
    .msg-bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
        line-height: 1.5;
        font-size: 0.95rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .msg-row.other .msg-bubble { background: var(--bg-panel); border-bottom-left-radius: 4px; color: var(--fg); }
    .msg-row.me .msg-bubble { background: var(--purple); color: #282a36; border-bottom-right-radius: 4px; font-weight: 600; }
    
    .msg-user { font-size: 0.75rem; color: var(--purple); margin-bottom: 4px; display: block; font-weight: bold; letter-spacing: 0.5px; }
    .msg-row.me .msg-user { display: none; }
    
    .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; transition: transform 0.2s; }
    .msg-img:hover { transform: scale(1.02); }
    
    .timestamp { font-size: 0.65rem; opacity: 0.6; text-align: right; margin-top: 4px; display: block; }
    
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    /* Input Container */
    .input-container {
      flex-shrink: 0;
      padding: 15px 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      background: var(--bg-dark);
      z-index: 10;
    }

    #reply-bar {
        background: var(--bg-panel); padding: 8px 15px; border-radius: 8px 8px 0 0;
        margin-bottom: -5px; display: none; justify-content: space-between; align-items: center;
        font-size: 0.85rem; color: #ddd; border-left: 4px solid var(--purple);
    }

    #chat-form { display: flex; gap: 12px; align-items: flex-end; }
    
    #msg-input {
      flex: 1;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--bg-panel);
      color: white; padding: 12px; border-radius: 12px;
      outline: none; resize: none; font-family: inherit;
      min-height: 48px; max-height: 150px;
      transition: border-color 0.2s;
    }
    #msg-input:focus { border-color: var(--purple); }
    
    .icon-btn {
        background: none; border: none; color: var(--purple); 
        font-size: 1.4rem; padding: 0 5px; cursor: pointer;
        transition: transform 0.1s; height: 48px; display: flex; align-items: center;
    }
    .icon-btn:hover { opacity: 0.8; transform: scale(1.1); }
    .send-btn { background: var(--purple); color: #282a36; border-radius: 50%; width: 48px; height: 48px; justify-content: center; }

    /* --- PANTALLA DE LOGIN --- */
    #login-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-dark); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .profiles-grid { display: flex; gap: 30px; margin-top: 2rem; flex-wrap: wrap; justify-content: center; }
    .profile-item { text-align: center; cursor: pointer; transition: transform 0.2s; }
    .profile-item:hover { transform: translateY(-10px); }
    .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--bg-panel); padding: 2px; object-fit: cover; }
    
    /* Responsive Mobile */
    @media (max-width: 768px) {
        #app-layout { grid-template-columns: 1fr; }
        .sidebar { display: none; position: absolute; height: 100%; width: 85%; box-shadow: 10px 0 30px rgba(0,0,0,0.8); }
        .sidebar.open { display: flex; }
        #mobile-menu { display: block; }
    }
  </style>
</head>
<body>

  <div id="login-screen">
      <h1 style="color:var(--purple); margin:0; font-size: 2.5rem; letter-spacing: 2px;">DRACULA CHAT</h1>
      <p style="color:var(--comment); margin-top: 10px;">Selecciona tu usuario</p>
      <div class="profiles-grid">
          <div class="profile-item" onclick="login('Rafa')">
              <img src="/images/Rafa.png" onerror="this.src='https://ui-avatars.com/api/?name=Rafa&background=bd93f9&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">Rafa</div>
          </div>
          <div class="profile-item" onclick="login('Hugo')">
              <img src="/images/Hugo.png" onerror="this.src='https://ui-avatars.com/api/?name=Hugo&background=50fa7b&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">Hugo</div>
          </div>
          <div class="profile-item" onclick="login('Sergio')">
              <img src="/images/Sergio.png" onerror="this.src='https://ui-avatars.com/api/?name=Sergio&background=ff5555&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">Sergio</div>
          </div>
          <div class="profile-item" onclick="login('√Ålvaro')">
              <img src="/images/√Ålvaro.png" onerror="this.src='https://ui-avatars.com/api/?name=Alvaro&background=8be9fd&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">√Ålvaro</div>
          </div>
      </div>
  </div>

  <div id="app-layout">
    
    <aside class="sidebar" id="sidebar">
        <div class="section-title">CANALES</div>
        <div class="nav-item active" id="btn-global" onclick="changeChat('global')">
            <span style="font-family:'Fira Code'; font-size:1.2rem; margin-right:5px; color: var(--cyan);">#</span> GLOBAL
        </div>

        <div class="section-title">MENSAJES DIRECTOS</div>
        <div id="dm-list"></div>

        <div style="margin-top:auto; padding-top:1rem; border-top:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; gap:12px;">
            <img id="my-avatar" src="" style="width:36px; height:36px; border-radius:50%;" onerror="this.style.display='none'">
            <div style="overflow: hidden;">
                <div id="my-name" style="font-weight:bold; font-size:0.95rem; white-space:nowrap;">...</div>
                <div style="font-size:0.75rem; color:var(--green); display:flex; align-items:center; gap:5px;">
                    <div class="status-dot"></div> En l√≠nea
                </div>
            </div>
        </div>
    </aside>

    <main class="chat-container">
        <header>
            <button id="mobile-menu">‚ò∞</button>
            <span id="header-icon" style="color:var(--comment); font-family:'Fira Code'; margin-right:10px;">#</span>
            <h3 id="chat-title" style="margin:0; letter-spacing: 1px;">GLOBAL</h3>
            <span id="typing" style="margin-left:15px; font-size:0.75rem; color:var(--yellow); font-style:italic;"></span>
        </header>

        <div id="messages-wrapper">
            <ul id="messages-list"></ul>
        </div>

        <div class="input-container">
            <div id="reply-bar">
                <span>Respondiendo a <strong id="reply-to-user" style="color:var(--purple)">User</strong></span>
                <span onclick="cancelReply()" style="cursor:pointer; color:var(--red); font-weight:bold;">‚úï</span>
            </div>
            
            <form id="chat-form">
                <input type="file" id="file-input" accept="image/*" style="display:none;">
                <button type="button" class="icon-btn" onclick="document.getElementById('file-input').click()" title="Enviar imagen">+</button>
                
                <textarea id="msg-input" rows="1" placeholder="Escribe un mensaje..."></textarea>
                
                <button type="submit" class="icon-btn send-btn">‚û§</button>
            </form>
        </div>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Estado
    let myUser = '';
    let activeChat = 'global'; 
    let replyId = null;
    let unread = {};
    let typingTimer;

    const els = {
        login: document.getElementById('login-screen'),
        sidebar: document.getElementById('sidebar'),
        dmList: document.getElementById('dm-list'),
        chatTitle: document.getElementById('chat-title'),
        headerIcon: document.getElementById('header-icon'),
        msgList: document.getElementById('messages-list'),
        msgWrapper: document.getElementById('messages-wrapper'),
        form: document.getElementById('chat-form'),
        input: document.getElementById('msg-input'),
        replyBar: document.getElementById('reply-bar'),
        replyUser: document.getElementById('reply-to-user'),
        typing: document.getElementById('typing'),
        btnGlobal: document.getElementById('btn-global')
    };

    // --- 1. LOGIN (CORE FIX) ---
    window.login = (user) => {
        console.log("Intentando login con:", user);
        // Enviamos el evento de login
        socket.emit('login', user);
    };

    // ESCUCHAMOS EL √âXITO DEL LOGIN
    socket.on('login success', (user) => {
        myUser = user;
        document.getElementById('my-name').textContent = user;
        
        const imgEl = document.getElementById('my-avatar');
        imgEl.src = `/images/${user}.png`;
        imgEl.onerror = function() {
            this.src = `https://ui-avatars.com/api/?name=${user}&background=bd93f9&color=fff`;
        };

        els.login.style.display = 'none';
        changeChat('global'); // Arrancar siempre en Global
    });

    // --- 2. CAMBIO DE CHAT ---
    window.changeChat = (target) => {
        activeChat = target;
        
        els.msgList.innerHTML = ''; 
        cancelReply();
        
        els.btnGlobal.classList.toggle('active', target === 'global');
        document.querySelectorAll('.nav-item[data-user]').forEach(el => {
            const isTarget = el.dataset.user === target;
            el.classList.toggle('active', isTarget);
            if(isTarget) {
                unread[target] = 0;
                const badge = el.querySelector('.unread-badge');
                if(badge) badge.style.display = 'none';
            }
        });

        if(target === 'global') {
            els.chatTitle.textContent = 'GLOBAL';
            els.headerIcon.textContent = '#';
            socket.emit('join chat', { target: null, type: 'global' });
        } else {
            els.chatTitle.textContent = target;
            els.headerIcon.textContent = '@';
            socket.emit('join chat', { target: target, type: 'private' });
        }

        if(window.innerWidth < 768) els.sidebar.classList.remove('open');
    };

    // --- 3. LISTA USUARIOS ---
    socket.on('update user list', (users) => {
        const others = users.filter(u => u !== myUser);
        els.dmList.innerHTML = others.map(u => {
            const count = unread[u] || 0;
            const display = count > 0 ? 'inline-block' : 'none';
            const activeClass = activeChat === u ? 'active' : '';
            return `
            <div class="nav-item ${activeClass}" data-user="${u}" onclick="changeChat('${u}')">
                <img src="/images/${u}.png" onerror="this.src='https://ui-avatars.com/api/?name=${u}&background=random'" class="nav-avatar">
                <span style="flex:1">${u}</span>
                <span class="unread-badge" style="display:${display}">${count}</span>
            </div>`;
        }).join('');
    });

    // --- 4. ENVIAR ---
    els.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = els.input.value.trim();
        if(!text) return;
        
        if(text === '/clear') socket.emit('clear chat request');
        else socket.emit('chat message', text, replyId, activeChat);

        els.input.value = '';
        els.input.style.height = 'auto';
        cancelReply();
        socket.emit('stop typing');
    });

    // --- 5. RECIBIR ---
    socket.on('chat message', (msg) => {
        let show = false;
        
        if (msg.isPrivate) {
            const partner = (msg.user === myUser) ? msg.receiver : msg.user;
            if (activeChat === partner) show = true;
            else if (msg.user !== myUser) {
                unread[partner] = (unread[partner] || 0) + 1;
                updateBadge(partner);
            }
        } else {
            if (activeChat === 'global') show = true;
        }

        if (show) {
            renderMessage(msg);
            scrollToBottom();
        }
    });

    socket.on('chat history', (data) => {
        if( (activeChat === 'global' && data.context === 'global') || activeChat === data.context ) {
            els.msgList.innerHTML = '';
            data.messages.forEach(renderMessage);
            scrollToBottom();
        }
    });

    // --- RENDERIZADO ---
    function renderMessage(msg) {
        const li = document.createElement('li');
        const isMe = msg.user === myUser;
        li.className = `msg-row ${isMe ? 'me' : 'other'}`;
        li.id = `msg-${msg.id}`;

        let content = '';
        if(msg.reply_to_id) content += `<div style="font-size:0.75rem; opacity:0.7; border-left:3px solid rgba(255,255,255,0.3); padding-left:8px; margin-bottom:6px; font-style:italic;">Respondiendo...</div>`;
        
        if(msg.type === 'image') {
            content += `<img src="${msg.text}" class="msg-img" onclick="window.open(this.src)">`;
        } else {
            content += msg.text.replace(/\n/g, '<br>');
        }

        const avatarSrc = `/images/${msg.user}.png`;
        const fallbackSrc = `https://ui-avatars.com/api/?name=${msg.user}&background=random&color=fff`;

        li.innerHTML = `
            <img src="${avatarSrc}" onerror="this.src='${fallbackSrc}'" class="msg-avatar">
            <div class="msg-bubble">
                <span class="msg-user">${msg.user}</span>
                ${content}
                <span class="timestamp">${new Date(parseInt(msg.timestamp)*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>
            <div style="display:flex; align-items:flex-end; padding-bottom:5px;">
                ${isMe ? 
                    `<button onclick="deleteMsg(${msg.id})" style="background:none;border:none;color:#ff5555;cursor:pointer; opacity:0.6; padding:5px;">üóë</button>` : 
                    `<button onclick="setReply(${msg.id}, '${msg.user}')" style="background:none;border:none;color:#ccc;cursor:pointer; opacity:0.6; padding:5px;">‚Ü©</button>`
                }
            </div>
        `;
        els.msgList.appendChild(li);
    }

    // --- UTILS ---
    function scrollToBottom() { els.msgWrapper.scrollTop = els.msgWrapper.scrollHeight; }
    
    function updateBadge(user) {
        const item = document.querySelector(`.nav-item[data-user="${user}"]`);
        if(item) {
            const b = item.querySelector('.unread-badge');
            b.textContent = unread[user];
            b.style.display = 'inline-block';
        }
    }

    window.setReply = (id, user) => {
        replyId = id;
        els.replyBar.style.display = 'flex';
        els.replyUser.textContent = user;
        els.input.focus();
    }
    window.cancelReply = () => {
        replyId = null;
        els.replyBar.style.display = 'none';
    }

    window.deleteMsg = (id) => {
        if(confirm('¬øEliminar?')) socket.emit('delete message', id);
    }
    socket.on('message deleted', id => {
        const el = document.getElementById(`msg-${id}`);
        if(el) el.remove();
    });

    document.getElementById('mobile-menu').onclick = () => els.sidebar.classList.toggle('open');

    els.input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        socket.emit('typing');
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => socket.emit('stop typing'), 1000);
    });

    document.getElementById('file-input').onchange = function() {
        if(this.files[0]) {
            const r = new FileReader();
            r.onload = (e) => {
                socket.emit('chat image', e.target.result, replyId, activeChat);
                cancelReply();
            };
            r.readAsDataURL(this.files[0]);
        }
        this.value = '';
    }

    socket.on('system message', txt => {
        const li = document.createElement('li');
        li.style.cssText = "text-align:center; color:var(--yellow); font-style:italic; font-size:0.8rem; margin:10px 0;";
        li.textContent = txt;
        els.msgList.appendChild(li);
        scrollToBottom();
    });

    socket.on('user typing', (u) => { if(u !== myUser) els.typing.textContent = `${u} escribe...`; });
    socket.on('user stop typing', () => { els.typing.textContent = ''; });
    socket.on('chat cleared', () => { els.msgList.innerHTML = ''; });

  </script>
</body>
</html>
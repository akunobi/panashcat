<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DRACULA CHAT // FINAL VERSION</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* --- PALETA DE COLORES DRÁCULA --- */
      --bg-dark: #282a36; 
      --bg-panel: #44475a; 
      --bg-sidebar: #21222c;
      --fg: #f8f8f2; 
      --comment: #6272a4;    
      --purple: #bd93f9;    
      --green: #50fa7b;     
      --red: #ff5555;      
      --yellow: #f1fa8c;
      --cyan: #8be9fd;
      --offline: #6272a4; /* Gris para usuarios desconectados */
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0; padding: 0;
      background-color: var(--bg-dark);
      color: var(--fg);
      font-family: 'Inter', sans-serif;
      height: 100dvh; /* Altura total del viewport */
      width: 100vw;
      overflow: hidden; /* Prevenir scroll en el cuerpo */
      display: flex;
    }

    /* =========================================
       LAYOUT PRINCIPAL (Flexbox)
       ========================================= */
    #app-layout {
      display: flex;
      width: 100%; 
      height: 100%;
    }
    
    /* =========================================
       SIDEBAR (IZQUIERDA)
       ========================================= */
    .sidebar {
        width: 260px; 
        flex-shrink: 0; /* Fijo, no encoger */
        background: var(--bg-sidebar);
        border-right: 1px solid rgba(255,255,255,0.1);
        display: flex; 
        flex-direction: column;
        padding: 1rem;
        overflow-y: auto; /* Scroll independiente */
        z-index: 20;
        transition: transform 0.3s ease;
    }

    .section-title {
        font-size: 0.7rem; color: var(--comment); 
        text-transform: uppercase; font-weight: bold;
        margin: 1.5rem 0 0.5rem 0;
        letter-spacing: 1px;
    }
    .section-title:first-child { margin-top: 0; }

    /* Botones de navegación (Canales/Usuarios) */
    .nav-item {
        display: flex; align-items: center; gap: 10px;
        padding: 10px; border-radius: 8px;
        cursor: pointer; color: #ccc; transition: 0.2s;
        margin-bottom: 4px;
    }
    .nav-item:hover { background: var(--bg-panel); color: #fff; }
    .nav-item.active { background: var(--bg-panel); color: var(--purple); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    
    /* Contenedor de Avatar con Estado */
    .avatar-box { position: relative; width: 28px; height: 28px; }
    .nav-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 1px solid var(--comment); }
    
    .status-dot { 
        width: 10px; height: 10px; border-radius: 50%; 
        position: absolute; bottom: -2px; right: -2px; 
        border: 2px solid var(--bg-sidebar); 
    }
    .status-dot.on { background: var(--green); box-shadow: 0 0 5px var(--green); }
    .status-dot.off { background: var(--offline); }

    /* Badge de mensajes no leídos */
    .unread-badge { 
        margin-left: auto; background: var(--red); color: white; 
        padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; 
        font-weight: bold; display: none; 
    }

    /* =========================================
       CHAT AREA (DERECHA)
       ========================================= */
    .chat-container {
      flex: 1; /* Ocupa el resto del espacio */
      display: flex; 
      flex-direction: column;
      height: 100%;
      position: relative;
      background: var(--bg-dark);
      min-width: 0; /* Evita desbordamiento */
    }

    /* CABECERA */
    header {
      height: 60px; flex-shrink: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; align-items: center; padding: 0 20px;
      background: rgba(40, 42, 54, 0.95);
    }
    #menu-btn { display: none; background: none; border: none; color: white; font-size: 1.5rem; margin-right: 15px; cursor: pointer; }
    #typing { margin-left: 15px; font-size: 0.75rem; color: var(--cyan); font-style: italic; }

    /* ZONA DE MENSAJES (SCROLL AQUÍ) */
    #messages-wrapper {
      flex-grow: 1; 
      overflow-y: auto; 
      padding: 20px;
      display: flex; 
      flex-direction: column;
      gap: 16px;
      min-height: 0; /* Fix crucial para Flexbox */
    }

    #messages-list {
      display: flex; flex-direction: column; gap: 16px;
      margin: 0; padding: 0; list-style: none;
      margin-top: auto; 
    }

    /* ESTILOS DE MENSAJE */
    .msg-row { display: flex; gap: 12px; animation: fadeIn 0.2s ease-out; max-width: 100%; }
    .msg-row.me { flex-direction: row-reverse; }
    
    .msg-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--bg-panel); }
    
    .msg-bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
        line-height: 1.5;
        font-size: 0.95rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .msg-row.other .msg-bubble { background: var(--bg-panel); border-bottom-left-radius: 4px; color: var(--fg); }
    .msg-row.me .msg-bubble { background: var(--purple); color: #282a36; border-bottom-right-radius: 4px; font-weight: 600; }
    
    .msg-user { font-size: 0.75rem; color: var(--purple); margin-bottom: 4px; display: block; font-weight: bold; letter-spacing: 0.5px; }
    .msg-row.me .msg-user { display: none; }
    
    .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; transition: transform 0.2s; }
    .msg-img:hover { transform: scale(1.02); }
    
    .timestamp { font-size: 0.65rem; opacity: 0.6; text-align: right; margin-top: 4px; display: block; }
    
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    /* ZONA DE INPUT (FIJA) */
    .input-container {
      flex-shrink: 0;
      padding: 15px 20px;
      background: var(--bg-dark);
      border-top: 1px solid rgba(255,255,255,0.1);
      z-index: 10;
    }

    #reply-bar {
        background: var(--bg-panel); padding: 8px 15px; border-radius: 8px 8px 0 0;
        margin-bottom: -5px; display: none; justify-content: space-between; align-items: center;
        font-size: 0.8rem; border-left: 4px solid var(--purple); color: #ccc;
    }

    #chat-form { display: flex; gap: 12px; align-items: flex-end; }
    
    #msg-input {
      flex: 1;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--bg-panel);
      color: white; padding: 12px; border-radius: 12px;
      outline: none; resize: none; font-family: inherit;
      min-height: 48px; max-height: 150px;
      transition: border-color 0.2s;
    }
    #msg-input:focus { border-color: var(--purple); }
    
    .icon-btn {
        background: none; border: none; color: var(--purple); 
        font-size: 1.4rem; padding: 0 5px; cursor: pointer;
        transition: transform 0.1s; height: 48px; display: flex; align-items: center;
    }
    .icon-btn:hover { opacity: 0.8; transform: scale(1.1); }
    .send-btn { background: var(--purple); color: #282a36; border-radius: 50%; width: 48px; height: 48px; justify-content: center; display: flex; align-items: center; }

    /* PANTALLA DE LOGIN */
    #login-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-dark); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .profiles-grid { display: flex; gap: 30px; margin-top: 2rem; flex-wrap: wrap; justify-content: center; }
    .profile-item { text-align: center; cursor: pointer; transition: transform 0.2s; }
    .profile-item:hover { transform: translateY(-10px); }
    .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--bg-panel); padding: 2px; object-fit: cover; }
    
    /* MEDIA QUERY PARA MÓVILES */
    @media (max-width: 768px) {
        .sidebar { position: absolute; height: 100%; width: 85%; box-shadow: 10px 0 30px rgba(0,0,0,0.8); transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        #menu-btn { display: block; }
    }
  </style>
</head>
<body>

  <div id="login-screen">
      <h1 style="color:var(--purple); margin:0; font-size: 2.5rem; letter-spacing: 2px;">DRACULA CHAT</h1>
      <p style="color:var(--comment); margin-top: 10px;">Selecciona tu usuario</p>
      <div class="profiles-grid">
          <div class="profile-item" onclick="tryLogin('Rafa')">
              <img src="/images/Rafa.png" onerror="this.src='https://ui-avatars.com/api/?name=Rafa&background=bd93f9&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">Rafa</div>
          </div>
          <div class="profile-item" onclick="tryLogin('Hugo')">
              <img src="/images/Hugo.png" onerror="this.src='https://ui-avatars.com/api/?name=Hugo&background=50fa7b&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">Hugo</div>
          </div>
          <div class="profile-item" onclick="tryLogin('Sergio')">
              <img src="/images/Sergio.png" onerror="this.src='https://ui-avatars.com/api/?name=Sergio&background=ff5555&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">Sergio</div>
          </div>
          <div class="profile-item" onclick="tryLogin('Álvaro')">
              <img src="/images/Álvaro.png" onerror="this.src='https://ui-avatars.com/api/?name=Alvaro&background=8be9fd&color=fff'" class="profile-img">
              <div style="margin-top:10px; font-weight:bold;">Álvaro</div>
          </div>
      </div>
  </div>

  <div id="app-layout">
    
    <aside class="sidebar">
        <div class="section-title">CANALES</div>
        <div class="nav-item active" id="btn-global" onclick="switchChat('global')">
            <span style="font-family:'Fira Code'; font-size:1.2rem; margin-right:5px; color: var(--cyan);">#</span> GLOBAL
        </div>

        <div class="section-title">MENSAJES DIRECTOS</div>
        <div id="dm-list"></div>

        <div style="margin-top:auto; padding-top:1rem; border-top:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; gap:12px;">
            <img id="my-avatar" src="" style="width:36px; height:36px; border-radius:50%;" onerror="this.style.display='none'">
            <div style="overflow: hidden;">
                <div id="my-name" style="font-weight:bold; font-size:0.95rem; white-space:nowrap;">...</div>
                <div style="font-size:0.75rem; color:var(--green);">● Conectado</div>
            </div>
        </div>
    </aside>

    <main class="chat-container">
        <header>
            <button id="menu-btn" onclick="document.querySelector('.sidebar').classList.toggle('open')">☰</button>
            <span style="color:var(--comment); font-family:'Fira Code'; margin-right:10px;">#</span>
            <h3 id="chat-title" style="margin:0; letter-spacing: 1px;">GLOBAL</h3>
            <span id="typing"></span>
        </header>

        <div id="messages-wrapper">
            <ul id="messages-list"></ul>
        </div>

        <div class="input-container">
            <div id="reply-bar">
                <span>Respondiendo a <strong id="reply-to" style="color:var(--purple)">...</strong></span>
                <span onclick="cancelReply()" style="cursor:pointer; color:var(--red);">✕</span>
            </div>
            
            <form id="form">
                <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="uploadFile()">
                <button type="button" class="icon-btn" onclick="document.getElementById('file-input').click()" title="Enviar imagen">+</button>
                
                <textarea id="msg-input" rows="1" placeholder="Escribe un mensaje..."></textarea>
                
                <button type="submit" class="icon-btn send-btn">➤</button>
            </form>
        </div>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // VARIABLES DE ESTADO
    let me = '';
    let currentChat = 'global'; 
    let replyId = null;
    let unread = {};
    let typingTimer;

    // ELEMENTOS DOM
    const els = {
        login: document.getElementById('login-screen'),
        dmList: document.getElementById('dm-list'),
        chatTitle: document.getElementById('chat-title'),
        msgList: document.getElementById('messages-list'),
        msgWrapper: document.getElementById('messages-wrapper'),
        form: document.getElementById('form'),
        input: document.getElementById('msg-input'),
        replyBar: document.getElementById('reply-bar'),
        replyUser: document.getElementById('reply-to'),
        typing: document.getElementById('typing'),
        btnGlobal: document.getElementById('btn-global')
    };

    // 1. LOGIN
    window.tryLogin = (user) => { socket.emit('login', user); };
    
    socket.on('login_success', (user) => {
        me = user;
        els.login.style.display = 'none';
        document.getElementById('my-name').textContent = user;
        document.getElementById('my-avatar').src = `/images/${user}.png`;
        document.getElementById('my-avatar').onerror = function(){ this.src = `https://ui-avatars.com/api/?name=${user}&background=random`; };
        switchChat('global');
    });

    // 2. CAMBIAR DE CHAT
    window.switchChat = (target) => {
        currentChat = target;
        els.msgList.innerHTML = ''; 
        cancelReply();
        
        // UI: Activar item seleccionado
        els.btnGlobal.classList.toggle('active', target === 'global');
        document.querySelectorAll('.nav-item[data-user]').forEach(el => {
            const isTarget = el.dataset.user === target;
            el.classList.toggle('active', isTarget);
            if(isTarget) {
                unread[target] = 0;
                el.querySelector('.unread-badge').style.display = 'none';
            }
        });

        // Cambiar título y pedir historial
        els.chatTitle.textContent = target === 'global' ? 'GLOBAL' : target;
        socket.emit('join_chat', { target });
        
        // Cerrar menú en móvil
        if(window.innerWidth < 768) document.querySelector('.sidebar').classList.remove('open');
    };

    // 3. RECIBIR MENSAJES
    socket.on('chat_message', (msg) => {
        let render = false;
        
        if(msg.isPrivate) {
            // ¿A quién pertenece el mensaje?
            // Si yo lo envié, el 'otro' es el destinatario.
            // Si yo lo recibí, el 'otro' es el remitente.
            const other = (msg.user === me) ? msg.receiver : msg.user;
            
            if(currentChat === other) {
                render = true;
            } else if(msg.user !== me) {
                unread[other] = (unread[other]||0) + 1;
                updateUserList();
            }
        } else {
            if(currentChat === 'global') render = true;
        }

        if(render) {
            addMsg(msg);
            scrollToBottom();
        }
    });

    // 4. HISTORIAL
    socket.on('chat_history', ({ history, context }) => {
        if(currentChat === context) {
            els.msgList.innerHTML = '';
            history.forEach(addMsg);
            scrollToBottom();
        }
    });

    // 5. LISTA DE USUARIOS
    socket.on('update_user_list', (users) => {
        window.usersCache = users; 
        updateUserList();
    });

    function updateUserList() {
        if(!window.usersCache) return;
        
        els.dmList.innerHTML = window.usersCache.filter(u => u.name !== me).map(u => {
            const count = unread[u.name] || 0;
            const statusClass = u.isOnline ? 'on' : 'off';
            const active = currentChat === u.name ? 'active' : '';
            
            return `
            <div class="nav-item ${active}" data-user="${u.name}" onclick="switchChat('${u.name}')">
                <div class="avatar-box">
                    <img src="/images/${u.name}.png" onerror="this.src='https://ui-avatars.com/api/?name=${u.name}&background=random'" class="nav-avatar">
                    <div class="status-dot ${statusClass}"></div>
                </div>
                <span style="flex:1">${u.name}</span>
                <span class="unread-badge" style="display:${count>0?'block':'none'}">${count}</span>
            </div>`;
        }).join('');
    }

    // 6. RENDERIZAR UN MENSAJE
    function addMsg(msg) {
        const li = document.createElement('li');
        const isMe = msg.user === me;
        li.className = `msg-row ${isMe ? 'me' : 'other'}`;
        li.id = `msg-${msg.id}`;

        let content = '';
        
        if(msg.replyTo) {
            content += `<div style="font-size:0.7rem;opacity:0.7;border-left:2px solid #fff;padding-left:5px;margin-bottom:5px">Respuesta...</div>`;
        }
        
        if(msg.type === 'image') {
            content += `<img src="${msg.text}" class="msg-img" onclick="window.open(this.src)">`;
        } else {
            content += msg.text.replace(/\n/g, '<br>');
        }

        li.innerHTML = `
            <img src="/images/${msg.user}.png" onerror="this.src='https://ui-avatars.com/api/?name=${msg.user}&background=random'" class="msg-avatar">
            <div class="msg-bubble">
                <span class="msg-user">${msg.user}</span>
                ${content}
                <span class="timestamp">${new Date(parseInt(msg.timestamp)*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>
            <div style="display:flex; align-items:flex-end; padding-bottom:5px;">
                ${isMe ? 
                    `<button onclick="delMsg(${msg.id})" style="background:none;border:none;color:#ff5555;cursor:pointer; opacity:0.6; padding:5px;">x</button>` : 
                    `<button onclick="reply(${msg.id}, '${msg.user}')" style="background:none;border:none;color:#ccc;cursor:pointer; opacity:0.6; padding:5px;">↩</button>`
                }
            </div>
        `;
        els.msgList.appendChild(li);
    }

    // 7. MANEJO DE EVENTOS
    els.form.onsubmit = (e) => {
        e.preventDefault();
        const text = els.input.value.trim();
        if(!text) return;
        
        if(text === '/clear') socket.emit('clear_chat');
        else socket.emit('chat_message', {
            text: text, type: 'text', replyTo: replyId, 
            target: currentChat // CRÍTICO: Enviar el target correcto
        });

        els.input.value = '';
        els.input.style.height = 'auto';
        cancelReply();
        socket.emit('stop_typing');
    };

    window.reply = (id, user) => {
        replyId = id;
        els.replyBar.style.display = 'flex';
        els.replyUser.textContent = user;
        els.input.focus();
    };
    window.cancelReply = () => {
        replyId = null;
        els.replyBar.style.display = 'none';
    };

    window.delMsg = (id) => { if(confirm('¿Borrar?')) socket.emit('delete_message', id); };
    socket.on('message_deleted', id => { const el=document.getElementById(`msg-${id}`); if(el) el.remove(); });
    socket.on('chat_cleared', () => els.msgList.innerHTML = '');
    socket.on('system_message', t => {
        const li=document.createElement('li'); 
        li.textContent=t; li.style.cssText="text-align:center;color:var(--yellow);font-size:0.8rem;margin:10px 0;";
        els.msgList.appendChild(li);
    });

    window.uploadFile = () => {
        const f = document.getElementById('file-input').files[0];
        if(f) {
            const r = new FileReader();
            r.onload = e => {
                socket.emit('chat_message', {
                    text: e.target.result, type: 'image', replyTo: replyId,
                    target: currentChat
                });
                cancelReply();
            };
            r.readAsDataURL(f);
            document.getElementById('file-input').value = '';
        }
    };

    function scrollToBottom() {
        els.msgWrapper.scrollTop = els.msgWrapper.scrollHeight;
    }

    els.input.addEventListener('input', function(){
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        socket.emit('typing');
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => socket.emit('stop_typing'), 1000);
    });

    socket.on('user_typing', (u) => { 
        if(u !== me && (currentChat === 'global' || currentChat === u)) {
            document.getElementById('typing').textContent = `${u} escribe...`;
        }
    });
    socket.on('user_stop_typing', () => { document.getElementById('typing').textContent = ''; });

</script>
</body>
</html>
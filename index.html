<!DOCTYPE html>
<html>
<head>
  <title>DRACULA CHAT // FINAL CON SIDEBAR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* --- PALETA DR√ÅCULA --- */
      --dracula-bg: #282a36; 
      --dracula-fg: #f8f8f2; 
      --dracula-selection: #44475a;  
      --dracula-comment: #6272a4;    
      
      --cyan: #8be9fd;      
      --green: #50fa7b;     
      --orange: #ffb86c;    
      --pink: #ff79c6;      
      --purple: #bd93f9;    
      --red: #ff5555;      
      --yellow: #f1fa8c;    

      /* --- VARIABLES GLOBALES --- */
      --bg-app: var(--dracula-bg);
      --bg-panel: var(--dracula-selection);
      --text-primary: var(--dracula-fg);
      --text-secondary: var(--dracula-comment);
      
      --accent: var(--purple); 
      --accent-hover: var(--pink); 

      /* Dimensiones */
      --header-height: 48px;
      --input-height: 60px;
      --typing-height: 20px;
      --user-list-width: 200px; 
    }

    /* Estilos Generales */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-app);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Estilos del Contenedor de la Aplicaci√≥n */
    #app {
      display: flex;
      flex-direction: column;
      flex-grow: 1; 
      overflow: hidden; 
    }

    /* Header */
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 15px;
      height: var(--header-height);
      background-color: var(--bg-panel);
      border-bottom: 1px solid var(--dracula-selection);
      font-weight: 600;
      z-index: 10;
    }
    #header span {
      cursor: pointer;
      color: var(--accent);
      font-size: 1.5rem;
    }
    #toggle-users {
        display: block; 
    }
    
    /* Contenedor principal de Mensajes y Usuarios */
    #chat-main {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
    }

    /* Contenedor de Mensajes (Chat √Årea) */
    #messages-container {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
        position: relative;
    }

    /* Lista de Mensajes (donde se aplica el scroll) */
    #messages {
      list-style-type: none;
      margin: 0;
      padding: 10px 10px var(--typing-height) 10px;
      flex-grow: 1; 
      overflow-y: auto; 
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    
    /* Estilos de Mensaje Individual */
    #messages li {
      padding: 5px 0;
      word-wrap: break-word;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
    }
    .msg-meta {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }
    .msg-user {
      font-weight: 700;
      color: var(--cyan);
      margin-right: 8px;
    }
    .msg-private-flag {
      color: var(--yellow);
      font-style: italic;
      margin-left: 8px;
    }
    .msg-timestamp {
      font-family: 'Fira Code', monospace;
      margin-left: 8px;
    }
    .msg-reply {
      padding-left: 10px;
      border-left: 3px solid var(--green);
      margin-bottom: 5px;
      cursor: pointer;
    }
    .msg-reply-user {
      color: var(--green);
      font-weight: 600;
      font-size: 0.8rem;
    }
    .msg-content {
      white-space: pre-wrap;
    }
    .msg-image img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
    }
    .msg-delete-btn {
      position: absolute;
      top: 5px;
      right: 0px;
      color: var(--red);
      cursor: pointer;
      font-size: 0.7rem;
      display: none;
    }
    #messages li:hover .msg-delete-btn {
      display: block;
    }

    /* System Messages */
    .msg-system {
      text-align: center;
      color: var(--orange);
      font-style: italic;
      padding: 10px 0;
    }

    /* Typing Indicator */
    #typing-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--typing-height);
      padding: 0 10px;
      font-size: 0.8rem;
      color: var(--green);
      background-color: var(--bg-app);
      z-index: 5;
    }

    /* Formulario de Entrada */
    #form {
      background: var(--dracula-bg);
      padding: 5px 10px;
      height: var(--input-height);
      display: flex;
      border-top: 1px solid var(--dracula-selection);
      align-items: center;
    }
    #form input {
      border: 0;
      padding: 10px;
      background: var(--bg-panel);
      color: var(--text-primary);
      flex-grow: 1;
      margin-right: 5px;
      border-radius: 5px;
      font-size: 1rem;
    }
    #form button, #form label {
      background: var(--accent);
      border: none;
      padding: 10px 15px;
      margin-left: 5px;
      color: var(--dracula-fg);
      cursor: pointer;
      border-radius: 5px;
      font-weight: 600;
      transition: background 0.2s;
    }
    #form button:hover, #form label:hover {
        background: var(--accent-hover);
    }
    #form button:disabled {
        background: var(--dracula-comment);
        cursor: not-allowed;
    }
    #file-input {
      display: none;
    }
    .reply-context {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(80, 250, 123, 0.1);
      padding: 5px 10px;
      font-size: 0.8rem;
      color: var(--green);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--green);
      z-index: 15; 
    }
    .reply-context span {
      max-width: 90%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .reply-context button {
      background: none;
      border: none;
      color: var(--red);
      cursor: pointer;
      font-weight: bold;
    }

    /* --- LOGIN OVERLAY --- */
    #login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(40, 42, 54, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #login-overlay h1 { 
        color: var(--accent); 
        font-family: 'Fira Code', monospace; 
    }
    #login-overlay input {
      padding: 10px;
      font-size: 1.2rem;
      margin-bottom: 10px;
      border: 2px solid var(--bg-panel);
      border-radius: 5px;
      background: var(--dracula-bg);
      color: var(--text-primary);
      text-align: center;
    }
    #login-overlay button {
      padding: 10px 20px;
      font-size: 1.2rem;
      background: var(--accent);
      color: var(--dracula-fg);
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #login-error {
      color: var(--red);
      margin-top: 10px;
    }

    /* --- SIDEBAR DE USUARIOS (ESCRITORIO) --- */
    #user-list-sidebar {
      width: var(--user-list-width);
      min-width: var(--user-list-width);
      background-color: var(--bg-panel);
      border-left: 1px solid var(--dracula-selection);
      overflow-y: auto;
      padding: 10px;
      display: none; 
    }
    #user-list-sidebar h3 {
        color: var(--accent);
        margin-top: 0;
        border-bottom: 1px solid var(--dracula-comment);
        padding-bottom: 5px;
    }
    #user-list-sidebar ul {
      list-style-type: none;
      padding: 0;
    }
    #user-list-sidebar li {
      padding: 8px 5px;
      cursor: pointer;
      transition: background 0.1s;
      border-radius: 3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #user-list-sidebar li:hover {
      background-color: var(--dracula-selection);
    }
    #user-list-sidebar li[data-context="active"] {
      background-color: var(--accent);
    }


    /* --- OVERLAY DE USUARIOS (M√ìVIL) --- */
    #user-list-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(40, 42, 54, 0.95);
      z-index: 50;
      display: none;
      flex-direction: column;
    }
    #user-list-overlay.visible {
        display: flex;
    }
    #user-list-overlay .overlay-header {
        height: var(--header-height);
        background-color: var(--bg-panel);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
        font-weight: 600;
    }
    #user-list-overlay .overlay-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        background-color: var(--dracula-bg);
    }
    #user-list-overlay .overlay-content ul {
        list-style-type: none;
        padding: 0;
    }
    #user-list-overlay .overlay-content li {
        padding: 12px 10px;
        cursor: pointer;
        border-bottom: 1px solid var(--dracula-selection);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #user-list-overlay .overlay-content li[data-context="active"] {
        background-color: var(--dracula-selection);
    }


    /* --- Media Queries (Adaptaci√≥n para Escritorio) --- */
    @media (min-width: 768px) {
        #toggle-users {
            display: none !important; 
        }
        #user-list-sidebar {
            display: block; 
        }
        #user-list-overlay {
            display: none !important; 
        }
    }
  </style>
</head>
<body>
    
    <div id="login-overlay">
        <h1>DRACULA CHAT</h1>
        <input type="text" id="username-input" placeholder="Introduce tu nombre (Rafa, Hugo, etc.)">
        <button id="login-button">Entrar</button>
        <div id="login-error"></div>
    </div>
    
    <div id="app" style="display: none;">
        
        <header id="header">
            <span id="chat-title">Chat Global</span>
            <div>
                <span id="toggle-users" role="button">üë•</span> 
                <span id="go-global" style="margin-left: 10px; color: var(--green); cursor: pointer; display: none;" title="Volver al chat global">üåç</span>
            </div>
        </header>

        <div id="chat-main">

            <div id="messages-container">
                <ul id="messages">
                    </ul>
                <div id="typing-indicator"></div>
            </div>

            <aside id="user-list-sidebar">
                <h3>üë• Usuarios Online</h3>
                <ul id="user-list-ul">
                    </ul>
            </aside>

            <div id="user-list-overlay">
                <div class="overlay-header">
                    <h3>üë• Usuarios Online</h3>
                    <span id="close-users" role="button">‚úï</span>
                </div>
                <div class="overlay-content">
                    <ul id="user-list-ul-overlay">
                        </ul>
                </div>
            </div>
        </div>

        <form id="form">
            <div id="reply-context" class="reply-context" style="display:none;">
                <span id="reply-text"></span>
                <button type="button" id="cancel-reply">‚úï</button>
            </div>

            <label for="file-input" title="Enviar Imagen" style="margin-right: 5px;">üñºÔ∏è</label>
            <input id="file-input" type="file" accept="image/*">

            <input id="input" autocomplete="off" placeholder="Escribe un mensaje...">
            <button id="send-button" type="submit">Enviar</button>
        </form>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- 1. SETUP DE VARIABLES Y ELEMENTOS DEL DOM ---
        const socket = io();
        let myUsername = null;
        let replyToMessage = null;
        let typingTimeout = null;
        const TYPING_TIMER_LENGTH = 1000;

        // Mapeo de elementos del DOM
        const els = {
            app: document.getElementById('app'),
            loginOverlay: document.getElementById('login-overlay'),
            loginInput: document.getElementById('username-input'),
            loginButton: document.getElementById('login-button'),
            loginError: document.getElementById('login-error'),
            
            chatTitle: document.getElementById('chat-title'),
            messages: document.getElementById('messages'),
            form: document.getElementById('form'),
            input: document.getElementById('input'),
            typing: document.getElementById('typing-indicator'),
            goGlobal: document.getElementById('go-global'),
            
            replyContext: document.getElementById('reply-context'),
            replyText: document.getElementById('reply-text'),
            cancelReply: document.getElementById('cancel-reply'),

            userListSidebar: document.getElementById('user-list-sidebar'),
            userListUl: document.getElementById('user-list-ul'),
            userListOverlay: document.getElementById('user-list-overlay'),
            userListUlOverlay: document.getElementById('user-list-ul-overlay'),
            toggleUsers: document.getElementById('toggle-users'),
            closeUsers: document.getElementById('close-users'),
            fileInput: document.getElementById('file-input'),
            sendButton: document.getElementById('send-button')
        };

        // Estado del chat
        let chatContext = {
            type: 'global', // 'global' o 'private'
            target: null // Nombre del usuario si es 'private'
        };
        
        // --- 2. FUNCIONES DE UI ---

        /** Mueve el scroll al final del chat. CR√çTICO para el scroll. */
        function scrollToBottom() {
            requestAnimationFrame(() => {
                els.messages.scrollTop = els.messages.scrollHeight;
            });
        }
        
        /** Maneja el cambio entre chat global y chat privado. */
        function switchContext(type, target = null) {
            if (chatContext.type === type && chatContext.target === target) return;

            els.messages.innerHTML = '';
            chatContext.type = type;
            chatContext.target = target;

            if (type === 'global') {
                els.chatTitle.textContent = 'Chat Global üåç';
                els.goGlobal.style.display = 'none';
                els.input.placeholder = 'Escribe un mensaje global...';
                socket.emit('get global history'); 
            } else {
                els.chatTitle.textContent = `DM: ${target} üí¨`;
                els.goGlobal.style.display = 'inline';
                els.input.placeholder = `Escribe un mensaje privado a ${target}...`;
                socket.emit('get private history', target); 
            }
            
            cancelReply();
            els.userListOverlay.classList.remove('visible');
            updateUserListHighlight();
        }
        
        /** Resalta el usuario activo en la lista de usuarios. */
        function updateUserListHighlight() {
            // Resaltar en Sidebar (Escritorio)
            Array.from(els.userListUl.children).forEach(li => {
                li.removeAttribute('data-context');
                if (chatContext.type === 'private' && li.dataset.user === chatContext.target) {
                    li.setAttribute('data-context', 'active');
                }
            });
             // Resaltar en Overlay (M√≥vil)
            Array.from(els.userListUlOverlay.children).forEach(li => {
                li.removeAttribute('data-context');
                if (chatContext.type === 'private' && li.dataset.user === chatContext.target) {
                    li.setAttribute('data-context', 'active');
                }
            });
        }

        /** Formatea la hora UNIX a HH:MM:SS */
        function formatTimestamp(ts) {
            if (!ts) return '';
            const date = new Date(ts * 1000);
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        /** Maneja la acci√≥n de responder a un mensaje. */
        function setReply(messageId, userName, messageText) {
            replyToMessage = { id: messageId, user: userName, text: messageText };
            els.replyText.textContent = `Respondiendo a ${userName}: "${messageText.substring(0, 30)}${messageText.length > 30 ? '...' : ''}"`;
            els.replyContext.style.display = 'flex';
        }

        /** Cancela el modo responder. */
        function cancelReply() {
            replyToMessage = null;
            els.replyContext.style.display = 'none';
            els.input.focus();
        }

        /** Crea y a√±ade un elemento de mensaje a la lista. */
        function addMessage(msg) {
            const li = document.createElement('li');
            li.id = `msg-${msg.id}`;
            li.dataset.id = msg.id;

            // Manejar mensajes de sistema
            if (msg.type === 'system') {
                li.classList.add('msg-system');
                li.textContent = msg.text;
                els.messages.appendChild(li);
                scrollToBottom();
                return;
            }

            // 1. Meta (Usuario, Privado, Timestamp)
            const meta = document.createElement('div');
            meta.classList.add('msg-meta');
            
            // Icono de perfil (asumiendo que las im√°genes est√°n en la carpeta 'images/')
            const profileIcon = document.createElement('img');
            profileIcon.src = `./images/${msg.user}.png`; 
            profileIcon.onerror = function() {
                this.src = `./images/${msg.user}.jpg`; // Fallback a .jpg
            };
            profileIcon.style.width = '20px';
            profileIcon.style.height = '20px';
            profileIcon.style.borderRadius = '50%';
            profileIcon.style.marginRight = '5px';
            profileIcon.style.verticalAlign = 'middle';
            meta.appendChild(profileIcon);
            
            // Nombre de Usuario
            const userSpan = document.createElement('span');
            userSpan.classList.add('msg-user');
            userSpan.textContent = msg.user;
            meta.appendChild(userSpan);
            
            // Flag Privado
            if (msg.isPrivate) {
                const privateFlag = document.createElement('span');
                privateFlag.classList.add('msg-private-flag');
                privateFlag.textContent = '(DM)';
                meta.appendChild(privateFlag);
            }
            
            // Timestamp
            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('msg-timestamp');
            timestampSpan.textContent = formatTimestamp(msg.timestamp);
            meta.appendChild(timestampSpan);
            
            li.appendChild(meta);

            // 2. Reply Context (Si existe)
            if (msg.reply_to_id) {
                const replyDiv = document.createElement('div');
                replyDiv.classList.add('msg-reply');
                replyDiv.title = 'Haga click para ir al mensaje original';
                
                replyDiv.onclick = () => {
                    const originalMsg = document.getElementById(`msg-${msg.reply_to_id}`);
                    if (originalMsg) {
                        originalMsg.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        originalMsg.style.backgroundColor = 'rgba(80, 250, 123, 0.2)';
                        setTimeout(() => originalMsg.style.backgroundColor = '', 1000);
                    } else {
                        // Mensaje de que el mensaje original no est√° cargado
                        alert(`Mensaje original #${msg.reply_to_id} no visible o no encontrado en el historial actual.`);
                    }
                };

                // Buscamos el usuario original en el DOM
                const originalMsg = document.getElementById(`msg-${msg.reply_to_id}`);
                const originalUser = originalMsg ? originalMsg.querySelector('.msg-user').textContent : 'Usuario Desconocido';
                
                const replyUserSpan = document.createElement('span');
                replyUserSpan.classList.add('msg-reply-user');
                replyUserSpan.textContent = `‚Ü™Ô∏è ${originalUser}`;
                replyDiv.appendChild(replyUserSpan);

                li.appendChild(replyDiv);
            }

            // 3. Contenido del Mensaje
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('msg-content');
            
            if (msg.type === 'image') {
                const img = document.createElement('img');
                img.src = msg.text; 
                img.classList.add('msg-image');
                contentDiv.appendChild(img);
            } else {
                contentDiv.textContent = msg.text;
            }
            li.appendChild(contentDiv);

            // 4. Bot√≥n Responder (Reply)
            const replyBtn = document.createElement('span');
            replyBtn.textContent = '‚Ü©Ô∏è Responder';
            replyBtn.style.color = 'var(--purple)';
            replyBtn.style.fontSize = '0.7rem';
            replyBtn.style.cursor = 'pointer';
            replyBtn.style.marginLeft = '10px';
            replyBtn.onclick = () => setReply(msg.id, msg.user, msg.text);
            meta.appendChild(replyBtn);

            // 5. Bot√≥n Eliminar
            if (msg.user === myUsername) {
                const deleteBtn = document.createElement('span');
                deleteBtn.textContent = '‚úï';
                deleteBtn.classList.add('msg-delete-btn');
                deleteBtn.onclick = () => {
                    if (confirm(`¬øSeguro que quieres eliminar este mensaje (ID: ${msg.id})?`)) {
                        socket.emit('delete message', msg.id, msg.isPrivate);
                    }
                };
                li.appendChild(deleteBtn);
            }

            els.messages.appendChild(li);
            scrollToBottom();
        }

        // --- 3. MANEJO DE EVENTOS (LISTENERS) ---

        // A. LOGIN (CORRECCI√ìN DE L√ìGICA)
        els.loginButton.onclick = () => {
            const username = els.loginInput.value.trim();
            if (username) {
                // Desactivar el bot√≥n para evitar clics dobles
                els.loginButton.disabled = true;
                els.loginError.textContent = 'Intentando conectar...';
                
                // El servidor devuelve un booleano (success)
                socket.emit('login', username, (success) => {
                    // Reactivar el bot√≥n, independientemente del resultado
                    els.loginButton.disabled = false;
                    
                    if (success) {
                        myUsername = username;
                        els.loginOverlay.style.display = 'none';
                        els.app.style.display = 'flex';
                        switchContext('global'); 
                        els.input.focus();
                    } else {
                        els.loginError.textContent = 'Nombre de usuario no permitido. Intenta con Rafa, Hugo, Sergio o √Ålvaro.';
                    }
                });
            }
        };
        els.loginInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') els.loginButton.click();
        });

        // B. ENV√çO DE MENSAJES (Texto)
        els.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = els.input.value.trim();
            const replyId = replyToMessage ? replyToMessage.id : null;
            
            if (text) {
                if (chatContext.type === 'global') {
                    socket.emit('chat message', text, replyId);
                } else {
                    socket.emit('private message', chatContext.target, text, replyId, 'text');
                }
                els.input.value = '';
                cancelReply();
            }
        });
        
        // C. ENV√çO DE IM√ÅGENES
        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            els.sendButton.disabled = true;
            els.input.placeholder = "Cargando imagen...";
            
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result;
                const replyId = replyToMessage ? replyToMessage.id : null;

                if (chatContext.type === 'global') {
                    socket.emit('chat image', base64Data, replyId);
                } else {
                    socket.emit('private message', chatContext.target, base64Data, replyId, 'image');
                }
                
                // Limpiar y restaurar
                els.fileInput.value = null; 
                els.sendButton.disabled = false;
                els.input.placeholder = "Escribe un mensaje...";
                cancelReply();
            };
            reader.readAsDataURL(file);
        });

        // D. INDICADOR DE ESCRITURA
        els.input.addEventListener('input', () => {
            if (!myUsername) return;
            
            if (!typingTimeout) {
                socket.emit('typing', chatContext.type === 'global' ? 'global' : chatContext.target);
            }

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop typing', chatContext.type === 'global' ? 'global' : chatContext.target);
                typingTimeout = null;
            }, TYPING_TIMER_LENGTH);
        });

        // E. NAVEGACI√ìN
        els.goGlobal.onclick = () => switchContext('global');
        els.cancelReply.onclick = cancelReply;

        // F. MOBILE OVERLAY
        els.toggleUsers.onclick = () => els.userListOverlay.classList.add('visible');
        els.closeUsers.onclick = () => els.userListOverlay.classList.remove('visible');

        // --- 4. SOCKET LISTENERS (SERVER) ---

        socket.on('chat message', (msg) => {
            if (chatContext.type === 'global') {
                addMessage(msg);
            }
        });
        
        socket.on('private message', (msg) => {
            const isTarget = (msg.user === myUsername && msg.recipient === chatContext.target) || 
                             (msg.user === chatContext.target && msg.recipient === myUsername);
                             
            if (isTarget) {
                addMessage(msg);
            }
        });
        
        socket.on('system message', (msg) => {
            addMessage({ type: 'system', text: msg });
        });

        // Historial (Global o Privado)
        socket.on('chat history', d => {
            if (d.type === 'global' && chatContext.type === 'global' || 
                d.type === 'private' && chatContext.type === 'private' && d.target === chatContext.target) {
                
                els.messages.innerHTML = '';
                // Usamos el campo correcto que viene del backend ('user_name' para global, 'sender' para privado)
                d.messages.forEach(m => addMessage({ ...m, isPrivate: d.type === 'private', user: m.user_name || m.sender }));
            }
        });
        
        // Manejo de acciones en mensajes
        socket.on('message deleted', id => { 
            const e = document.getElementById(`msg-${id}`); 
            if(e) e.remove(); 
            if (replyToMessage && replyToMessage.id === id) cancelReply();
        });
        socket.on('chat cleared', () => els.messages.innerHTML = '');

        // Typing
        const typers = new Set();
        socket.on('user typing', d => {
            if (d.user === myUsername) return;
            // Solo mostrar si es el contexto correcto
            if (d.context !== chatContext.type) return;
            if (d.context === 'private' && d.user !== chatContext.target) return;

            typers.add(d.user);
            els.typing.textContent = typers.size ? `${Array.from(typers).join(', ')} est√° escribiendo...` : '';
            scrollToBottom();
        });
        
        socket.on('user stop typing', d => {
            typers.delete(d.user);
            els.typing.textContent = typers.size ? `${Array.from(typers).join(', ')} est√° escribiendo...` : '';
            if (typers.size === 0) {
                 els.typing.textContent = '';
            }
        });

        // Lista de Usuarios
        socket.on('update user list', users => {
            const userHtml = users.map(u => `
                <li data-user="${u}" onclick="${u === myUsername ? '' : `switchContext('private', '${u}')`}">
                    ${u} 
                    ${u === myUsername ? '<span style="font-size:0.8rem; float:right; color:var(--green);">üü¢ Yo</span>' : 
                                         '<span style="font-size:0.8rem; float:right; color:var(--accent);">üí¨ DM</span>'}
                </li>
            `).join('');

            // Actualizar ambas listas y mantener el data-user para el highlight
            els.userListUl.innerHTML = userHtml;
            els.userListUlOverlay.innerHTML = userHtml;
            updateUserListHighlight();
        });
        
        // --- 5. INITIAL CONNECTION / RECONNECT LOGIC ---
        socket.on('connect', () => {
            if (myUsername) {
                // Reintentar login autom√°ticamente en caso de reconexi√≥n
                socket.emit('login', myUsername, (success) => {
                    if (success) {
                        console.log('Reconexi√≥n exitosa.');
                        // Volver a cargar el historial del contexto actual
                        if (chatContext.type === 'global') {
                            socket.emit('get global history');
                        } else if (chatContext.target) {
                            socket.emit('get private history', chatContext.target);
                        }
                    } else {
                         // Si la reconexi√≥n falla, llevar al login por seguridad
                         console.error('Fallo en la reconexi√≥n.');
                         // No hacemos nada, el usuario podr√≠a haber sido desconectado por el servidor
                    }
                });
            }
        });

    </script>
</body>
</html>
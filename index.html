<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DRACULA CHAT // DMs Update</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* --- PALETA DRÁCULA --- */
      --dracula-bg: #282a36; 
      --dracula-fg: #f8f8f2; 
      --dracula-selection: #44475a;  
      --dracula-comment: #6272a4;    
      --purple: #bd93f9;    
      --green: #50fa7b;     
    }

    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--dracula-bg); color: var(--dracula-fg); overflow: hidden; }

    /* --- LOGIN OVERLAY --- */
    #login-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--dracula-bg); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .login-box {
        background: var(--dracula-selection); padding: 2rem; border-radius: 12px;
        text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    input[type="text"] {
        padding: 12px; border-radius: 6px; border: none; width: 250px;
        background: #21222c; color: white; outline: none; margin-bottom: 1rem;
    }
    button.btn-primary {
        padding: 10px 24px; background: var(--purple); border: none; 
        border-radius: 6px; color: #282a36; font-weight: bold; cursor: pointer;
        transition: transform 0.1s;
    }
    button.btn-primary:active { transform: scale(0.98); }

    /* --- APP LAYOUT (GRID) --- */
    #app-container {
        display: none; /* Se activa con JS */
        display: grid; 
        grid-template-columns: 260px 1fr; /* Sidebar | Chat */
        height: 100vh; width: 100vw;
    }

    /* --- SIDEBAR --- */
    .sidebar {
        background: #21222c; /* Tono más oscuro */
        border-right: 1px solid var(--dracula-selection);
        display: flex; flex-direction: column;
        padding: 1rem;
        overflow-y: auto;
    }

    .group-label {
        font-size: 0.75rem; color: var(--dracula-comment);
        text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
        margin: 1.5rem 0 0.5rem 0;
    }

    .nav-item {
        display: flex; align-items: center; gap: 10px;
        padding: 10px; margin-bottom: 4px;
        border-radius: 6px; cursor: pointer;
        color: #ccc; transition: all 0.2s;
    }
    .nav-item:hover { background: var(--dracula-selection); color: #fff; }
    .nav-item.active { background: var(--dracula-selection); color: var(--purple); font-weight: 600; }

    .nav-avatar {
        width: 32px; height: 32px; border-radius: 50%; 
        background: var(--dracula-comment); color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 12px; font-weight: bold;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; margin-left: auto; }
    .status-dot.online { background: var(--green); box-shadow: 0 0 5px var(--green); }
    
    .unread-badge {
        background: var(--purple); color: #fff; font-size: 0.7rem; 
        padding: 2px 6px; border-radius: 10px; margin-left: auto; 
        display: none; /* Oculto por defecto */
    }

    /* --- CHAT AREA --- */
    .chat-area {
        display: flex; flex-direction: column;
        position: relative; height: 100vh;
        background: var(--dracula-bg);
    }

    /* HEADER */
    header {
        height: 60px; border-bottom: 1px solid var(--dracula-selection);
        display: flex; align-items: center; padding: 0 20px;
        background: var(--dracula-bg); font-weight: 600; font-size: 1.1rem;
    }
    .header-icon { color: var(--dracula-comment); margin-right: 10px; font-family: 'Fira Code', monospace; }

    /* MESSAGES LIST */
    #messages {
        flex: 1; overflow-y: auto; padding: 20px;
        display: flex; flex-direction: column; gap: 15px;
    }
    
    /* INPUT AREA */
    .input-area {
        padding: 20px; background: var(--dracula-bg);
        border-top: 1px solid var(--dracula-selection);
    }
    #chat-form { display: flex; gap: 12px; align-items: flex-end; }
    
    #msg-input {
        flex: 1; background: var(--dracula-selection); border: none;
        color: white; padding: 14px; border-radius: 8px; outline: none;
        font-family: inherit; resize: none; min-height: 50px; max-height: 150px;
        line-height: 1.4;
    }
    
    /* --- MESSAGE STYLES --- */
    .message { display: flex; gap: 14px; animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
    
    .msg-avatar { 
        width: 40px; height: 40px; border-radius: 50%; background: var(--purple); 
        display:flex; align-items:center; justify-content:center; font-weight:bold; color:#282a36; flex-shrink: 0;
    }
    .msg-content { display: flex; flex-direction: column; max-width: 85%; }
    .msg-header { margin-bottom: 4px; display: flex; align-items: baseline; gap: 8px; }
    .msg-user { color: var(--purple); font-weight: 600; cursor: pointer; }
    .msg-time { font-size: 0.75rem; color: var(--dracula-comment); }
    .msg-text { line-height: 1.5; white-space: pre-wrap; word-break: break-word; color: #e2e2e2; }
    
    /* Contexto de Respuesta */
    #reply-ctx {
        display:none; align-items: center; justify-content: space-between;
        background: #343746; padding: 8px 16px; 
        border-left: 3px solid var(--purple); margin-bottom: 10px; border-radius: 4px;
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: var(--dracula-selection); border-radius: 4px; }

    /* Responsive Móvil */
    @media (max-width: 768px) {
        #app-container { grid-template-columns: 1fr; }
        .sidebar { display: none; position: absolute; z-index: 100; height: 100%; width: 80%; }
        .sidebar.show { display: flex; }
        #mobile-menu-btn { display: block !important; margin-right: 10px; }
    }
  </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="margin-top:0; color:var(--purple);">DRACULA CHAT</h2>
        <form id="login-form">
            <input type="text" id="username-input" placeholder="Elige tu nombre..." autocomplete="off">
            <br>
            <button type="submit" class="btn-primary">ENTRAR</button>
        </form>
    </div>
</div>

<div id="app-container" style="display:none;"> <aside class="sidebar" id="sidebar">
        <div class="nav-item active" id="btn-global">
            <div class="nav-avatar" style="background: transparent; color: var(--dracula-comment); font-size: 1.2rem;">#</div>
            <span>CANAL GLOBAL</span>
        </div>

        <div class="group-label">MENSAJES DIRECTOS</div>
        <div id="dm-list">
            </div>

        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid #444;">
            <div class="nav-item" style="cursor: default;">
                <div class="nav-avatar" id="my-avatar-display">yo</div>
                <div style="display:flex; flex-direction:column; line-height:1.2;">
                    <span id="my-username-display" style="font-weight:bold; font-size:0.9rem;">...</span>
                    <span style="font-size:0.7rem; color: #888;">En línea</span>
                </div>
            </div>
        </div>
    </aside>

    <main class="chat-area">
        <header>
            <button id="mobile-menu-btn" style="display:none; background:none; border:none; color:white; font-size:1.5rem;">☰</button>
            <span class="header-icon" id="header-icon">#</span>
            <span id="chat-title">GLOBAL</span>
            <span id="typing-indicator" style="margin-left: 15px; font-size: 0.8rem; color: var(--dracula-comment); font-weight: 400;"></span>
        </header>

        <div id="messages"></div>

        <div class="input-area">
            <div id="reply-ctx">
                <span style="font-size: 0.9rem; color: #ccc;">Respondiendo a <strong id="reply-to-user">User</strong></span>
                <button id="close-reply" style="background:none; border:none; color:#fff; cursor:pointer;">✕</button>
            </div>

            <form id="chat-form">
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <button type="button" id="btn-file" style="background:none; border:none; color: var(--purple); font-size: 1.5rem; cursor: pointer; padding-bottom: 5px;">+</button>
                
                <textarea id="msg-input" placeholder="Enviar mensaje..." rows="1"></textarea>
                <button type="submit" class="btn-primary">Enviar</button>
            </form>
        </div>
    </main>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    // --- DOM ELEMENTS ---
    const els = {
        loginScreen: document.getElementById('login-screen'),
        loginForm: document.getElementById('login-form'),
        userInput: document.getElementById('username-input'),
        app: document.getElementById('app-container'),
        
        sidebar: document.getElementById('sidebar'),
        dmList: document.getElementById('dm-list'),
        btnGlobal: document.getElementById('btn-global'),
        
        chatTitle: document.getElementById('chat-title'),
        headerIcon: document.getElementById('header-icon'),
        messages: document.getElementById('messages'),
        
        form: document.getElementById('chat-form'),
        input: document.getElementById('msg-input'),
        fileInput: document.getElementById('file-input'),
        btnFile: document.getElementById('btn-file'),
        
        replyCtx: document.getElementById('reply-ctx'),
        replyUser: document.getElementById('reply-to-user'),
        closeReply: document.getElementById('close-reply'),
        
        myUserDisplay: document.getElementById('my-username-display'),
        myAvatarDisplay: document.getElementById('my-avatar-display'),
        mobileBtn: document.getElementById('mobile-menu-btn')
    };

    // --- ESTADO ---
    let myUsername = '';
    let activeChat = 'global'; // 'global' o nombre de usuario
    let currentReplyToId = null;
    let unreadCounts = {}; // { 'pepe': 2 }

    // 1. LOGIN
    els.loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const val = els.userInput.value.trim();
        if(val) socket.emit('login', val);
    });

    socket.on('login success', (user) => {
        myUsername = user;
        els.loginScreen.style.display = 'none';
        els.app.style.display = 'grid'; // Mostrar App
        els.myUserDisplay.textContent = user;
        els.myAvatarDisplay.textContent = user.charAt(0).toUpperCase();

        // Iniciar en Global
        switchChat('global');
    });

    // 2. CAMBIO DE CHAT (SIDEBAR)
    els.btnGlobal.onclick = () => switchChat('global');

    function switchChat(target) {
        activeChat = target;
        
        // UI Reset
        els.messages.innerHTML = '';
        cancelReply();
        
        // Highlight en Sidebar
        els.btnGlobal.classList.toggle('active', target === 'global');
        document.querySelectorAll('.dm-item').forEach(el => {
            const isTarget = el.dataset.user === target;
            el.classList.toggle('active', isTarget);
            
            // Si entramos al chat, limpiar notificaciones
            if(isTarget) {
                unreadCounts[target] = 0;
                const badge = el.querySelector('.unread-badge');
                if(badge) badge.style.display = 'none';
            }
        });

        // Header Update
        if(target === 'global') {
            els.chatTitle.textContent = "CANAL GLOBAL";
            els.headerIcon.textContent = "#";
            socket.emit('join chat room', { target: null, type: 'global' });
        } else {
            els.chatTitle.textContent = target;
            els.headerIcon.textContent = "@";
            socket.emit('join chat room', { target: target, type: 'private' });
        }

        // Móvil: ocultar sidebar tras click
        if(window.innerWidth < 768) els.sidebar.classList.remove('show');
    }

    // 3. ACTUALIZAR LISTA DE USUARIOS
    socket.on('update user list', (users) => {
        const others = users.filter(u => u !== myUsername);
        
        els.dmList.innerHTML = others.map(u => {
            const count = unreadCounts[u] || 0;
            const badgeStyle = count > 0 ? 'display:block' : 'display:none';
            const isActive = activeChat === u ? 'active' : '';

            return `
            <div class="nav-item dm-item ${isActive}" data-user="${u}" onclick="switchChat('${u}')">
                <div class="nav-avatar">${u.charAt(0).toUpperCase()}</div>
                <span style="flex:1; overflow:hidden; text-overflow:ellipsis;">${u}</span>
                <span class="unread-badge" style="${badgeStyle}">${count}</span>
                <div class="status-dot online"></div>
            </div>`;
        }).join('');
    });

    // 4. ENVIAR MENSAJE
    els.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = els.input.value.trim();
        if(!text) return;

        socket.emit('chat message', {
            text: text,
            type: 'text',
            replyTo: currentReplyToId,
            // Datos clave para privado
            isPrivate: activeChat !== 'global',
            targetUser: activeChat !== 'global' ? activeChat : null
        });

        els.input.value = '';
        els.input.style.height = 'auto';
        cancelReply();
    });

    // 5. RECIBIR MENSAJE (GLOBAL)
    socket.on('chat message', (msg) => {
        if(activeChat === 'global') {
            renderMessage(msg);
        }
    });

    // 6. RECIBIR MENSAJE (PRIVADO)
    socket.on('private message incoming', (msg) => {
        // ¿Quién es la otra persona en esta conversación?
        const otherPerson = (msg.user_name === myUsername) ? msg.receiver : msg.user_name;

        // Si tengo abierto ese chat, mostrar mensaje
        if(activeChat === otherPerson) {
            renderMessage(msg);
        } else {
            // Si no, aumentar contador de no leídos
            // (Si fui yo quien lo envié desde otro dispositivo, no contar como no leído)
            if(msg.user_name !== myUsername) {
                unreadCounts[otherPerson] = (unreadCounts[otherPerson] || 0) + 1;
                updateBadge(otherPerson);
            }
        }
    });

    function updateBadge(user) {
        const item = document.querySelector(`.dm-item[data-user="${user}"]`);
        if(item) {
            const badge = item.querySelector('.unread-badge');
            badge.textContent = unreadCounts[user];
            badge.style.display = 'block';
        }
    }

    // 7. HISTORIAL
    socket.on('chat history', (history) => {
        history.forEach(m => renderMessage(m));
        scrollToBottom();
    });

    // 8. RENDERIZADO VISUAL
    function renderMessage(msg) {
        const div = document.createElement('div');
        div.className = 'message';
        div.id = `msg-${msg.id}`;
        
        // Manejo de Respuesta (Reply) Visual
        let replyHtml = '';
        if(msg.reply_to_id) {
            replyHtml = `<div style="font-size:0.8rem; color:#888; border-left:2px solid #666; padding-left:5px; margin-bottom:5px; cursor:pointer;" onclick="scrollToMsg(${msg.reply_to_id})">Respuesta a un mensaje...</div>`;
        }

        // Contenido (Texto o Imagen)
        let contentHtml = `<div class="msg-text">${msg.text}</div>`;
        if(msg.message_type === 'image') {
            contentHtml = `<img src="${msg.text}" style="max-width:100%; border-radius:8px; margin-top:5px;">`;
        }

        div.innerHTML = `
            <div class="msg-avatar">${msg.user_name.charAt(0).toUpperCase()}</div>
            <div class="msg-content">
                <div class="msg-header">
                    <span class="msg-user" onclick="startReply(${msg.id}, '${msg.user_name}')">${msg.user_name}</span>
                    <span class="msg-time">${new Date(parseInt(msg.timestamp)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                ${replyHtml}
                ${contentHtml}
            </div>
        `;
        els.messages.appendChild(div);
        scrollToBottom();
    }

    // --- UTILS ---
    function scrollToBottom() { els.messages.scrollTop = els.messages.scrollHeight; }

    function startReply(id, user) {
        currentReplyToId = id;
        els.replyCtx.style.display = 'flex';
        els.replyUser.textContent = user;
        els.input.focus();
    }
    
    function cancelReply() {
        currentReplyToId = null;
        els.replyCtx.style.display = 'none';
    }
    els.closeReply.onclick = cancelReply;

    function scrollToMsg(id) {
        const el = document.getElementById(`msg-${id}`);
        if(el) {
            el.scrollIntoView({behavior: 'smooth', block: 'center'});
            el.style.background = '#44475a';
            setTimeout(() => el.style.background = 'transparent', 1500);
        }
    }

    // Auto-crecimiento textarea
    els.input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // Manejo de Imágenes
    els.btnFile.onclick = () => els.fileInput.click();
    els.fileInput.onchange = (e) => {
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            // Enviar como imagen
            socket.emit('chat message', {
                text: evt.target.result, 
                type: 'image',
                replyTo: currentReplyToId,
                isPrivate: activeChat !== 'global',
                targetUser: activeChat !== 'global' ? activeChat : null
            });
            cancelReply();
        };
        reader.readAsDataURL(f);
        els.fileInput.value = '';
    }

    // Botón Móvil
    els.mobileBtn.onclick = () => els.sidebar.classList.toggle('show');
    
    // Sistema (limpiezas, etc)
    socket.on('chat cleared', () => els.messages.innerHTML = '');
    socket.on('message deleted', (id) => {
        const el = document.getElementById(`msg-${id}`);
        if(el) el.remove();
    });

</script>
</body>
</html>